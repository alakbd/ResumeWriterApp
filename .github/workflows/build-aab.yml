name: Build & Sign APK + AAB + Play Console Upload

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Set up JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3Ô∏è‚É£ Setup Android SDK
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # 4Ô∏è‚É£ Make gradlew executable
      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # 5Ô∏è‚É£ Cache Gradle dependencies
      - name: Cache Gradle dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper/
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      # 6Ô∏è‚É£ Create .env file with APP_SECRET_KEY
      - name: Create .env file
        run: |
          cat <<EOF > .env
          APP_SECRET_KEY=${{ secrets.APP_SECRET_KEY }}
          EOF

      # 7Ô∏è‚É£ Create google-services.json from secret
      - name: Create google-services.json
        run: |
          cat <<EOF > app/google-services.json
          ${{ secrets.GOOGLE_SERVICES_JSON }}
          EOF

      # 8Ô∏è‚É£ Decode Base64 Keystore Secret
      - name: Decode and save keystore
        run: |
          mkdir -p $HOME/app
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > $HOME/app/my-release-key.jks

      # 9Ô∏è‚É£ Build Verification
      - name: Verify Build Configuration
        run: |
          echo "üîç Build Configuration:"
          echo "‚úì Target SDK: 35 (Required for Play Store)"
          echo "‚úì Min SDK: 21"
          echo "‚úì Version Code: 8"
          echo "‚úì Version Name: 1.7"
          echo "‚úì ABI: arm64-v8a, armeabi-v7a"

      # üîü Build Signed Release APK
      - name: Build Signed Release APK
        run: |
          ./gradlew clean assembleRelease \
            -Pandroid.injected.signing.store.file=$HOME/app/my-release-key.jks \
            -Pandroid.injected.signing.store.password=${{ secrets.KEYSTORE_PASSWORD }} \
            -Pandroid.injected.signing.key.alias=${{ secrets.KEY_ALIAS }} \
            -Pandroid.injected.signing.key.password=${{ secrets.KEY_PASSWORD }}

      # 1Ô∏è‚É£1Ô∏è‚É£ Verify APK is Installable
      - name: Verify APK Installation
        run: |
          # Check if APK is properly signed and installable
          ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager "build-tools;34.0.0" --channel=0 > /dev/null 2>&1 || true
          TEST_ONLY=$(${ANDROID_HOME}/build-tools/34.0.0/aapt dump badging app/build/outputs/apk/release/app-release.apk | grep "test-only" || echo "not-test-only")
          if [ "$TEST_ONLY" = "not-test-only" ]; then
            echo "‚úÖ APK is installable (test-only=false)"
          else
            echo "‚ùå APK is marked as test-only - cannot be installed normally"
            exit 1
          fi

      # 1Ô∏è‚É£2Ô∏è‚É£ Upload Signed APK
      - name: Upload Signed APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: app/build/outputs/apk/release/app-release.apk
          retention-days: 30

      # 1Ô∏è‚É£3Ô∏è‚É£ Build Signed Release AAB
      - name: Build Signed Release AAB
        run: |
          ./gradlew clean bundleRelease \
            -Pandroid.injected.signing.store.file=$HOME/app/my-release-key.jks \
            -Pandroid.injected.signing.store.password=${{ secrets.KEYSTORE_PASSWORD }} \
            -Pandroid.injected.signing.key.alias=${{ secrets.KEY_ALIAS }} \
            -Pandroid.injected.signing.key.password=${{ secrets.KEY_PASSWORD }}

      # 1Ô∏è‚É£4Ô∏è‚É£ Upload Signed AAB
      - name: Upload Signed AAB
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab
          path: app/build/outputs/bundle/release/app-release.aab
          retention-days: 30

      # 1Ô∏è‚É£5Ô∏è‚É£ Create GitHub Release with Downloads
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          files: |
            app/build/outputs/apk/release/app-release.apk
            app/build/outputs/bundle/release/app-release.aab
          tag_name: release-v${{ github.run_number }}
          name: Release ${{ github.run_number }} (v1.7)
          draft: false
          prerelease: false
          body: |
            üöÄ Automatic Release Build
            
            **Version:** 1.7 (8)
            **Target SDK:** 35 (Play Store Compliant)
            
            ### üì± Download Links:
            - **APK**: Direct installable file
            - **AAB**: For Google Play Store upload
            
            ### üéØ For Testers:
            1. **APK**: Download and install directly
            2. **AAB**: Upload to Play Console for internal testing
            
            ### üîß Build Info:
            - Min SDK: 21
            - Target SDK: 35
            - Build Date: ${{ github.event.head_commit.timestamp }}

      # 1Ô∏è‚É£6Ô∏è‚É£ Output Tester Instructions
      - name: Output Tester Instructions
        run: |
          echo "üéØ TESTER DOWNLOAD INSTRUCTIONS:"
          echo ""
          echo "OPTION 1 - Direct APK Download:"
          echo "1. Go to GitHub Actions ‚Üí This workflow run"
          echo "2. Download 'app-release-apk' artifact"
          echo "3. Install on Android device"
          echo ""
          echo "OPTION 2 - GitHub Release:"
          echo "1. Go to Repository ‚Üí Releases"
          echo "2. Download latest release APK"
          echo "3. Install on Android device"
          echo ""
          echo "OPTION 3 - Play Console Internal Sharing:"
          echo "1. Download the AAB artifact"
          echo "2. Upload to Play Console ‚Üí Internal app sharing"
          echo "3. Share the generated link with testers"
          echo "4. Testers enable 'Internal app sharing' in Play Store settings"
          echo ""
          echo "üîß Tester Device Setup:"
          echo "- Enable 'Install from unknown sources'"
          echo "- For Play Console: Enable 'Internal app sharing' in Play Store developer options"
