name: Build & Sign APK + AAB + Play Console Upload

on:
  push:
    branches: [ "main" ]

# Add permissions for GitHub Releases
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Set up JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3Ô∏è‚É£ Setup Android SDK
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # 4Ô∏è‚É£ Make gradlew executable
      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # 5Ô∏è‚É£ Cache Gradle dependencies
      - name: Cache Gradle dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper/
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      # 6Ô∏è‚É£ Create .env file with APP_SECRET_KEY
      - name: Create .env file
        run: |
          cat <<EOF > .env
          APP_SECRET_KEY=${{ secrets.APP_SECRET_KEY }}
          EOF

      # 7Ô∏è‚É£ Create google-services.json from secret
      - name: Create google-services.json
        run: |
          cat <<EOF > app/google-services.json
          ${{ secrets.GOOGLE_SERVICES_JSON }}
          EOF

      # 8Ô∏è‚É£ Decode Base64 Keystore Secret
      - name: Decode and save keystore
        run: |
          mkdir -p $HOME/app
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > $HOME/app/my-release-key.jks

      # 9Ô∏è‚É£ Build Verification
      - name: Verify Build Configuration
        run: |
          echo "üîç Build Configuration:"
          echo "‚úì Target SDK: 35 (Required for Play Store)"
          echo "‚úì Min SDK: 21"
          echo "‚úì Version Code: 10"
          echo "‚úì Version Name: 1.9"

      # üîü Build Signed Release APK
      - name: Build Signed Release APK
        run: |
          ./gradlew clean assembleRelease \
            -Pandroid.injected.signing.store.file=$HOME/app/my-release-key.jks \
            -Pandroid.injected.signing.store.password=${{ secrets.KEYSTORE_PASSWORD }} \
            -Pandroid.injected.signing.key.alias=${{ secrets.KEY_ALIAS }} \
            -Pandroid.injected.signing.key.password=${{ secrets.KEY_PASSWORD }}

      # 1Ô∏è‚É£1Ô∏è‚É£ Find and Verify APK
      - name: Find and Verify APK
        run: |
          echo "üìÅ Listing build outputs..."
          find app/build/outputs -name "*.apk" -type f | head -10
          find app/build/outputs -name "*.aab" -type f | head -10
          
          # Check if release APK exists
          if [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
            echo "‚úÖ Release APK found"
            ls -la app/build/outputs/apk/release/
          else
            echo "üîç Searching for APK in other locations..."
            find app/build/outputs -name "*.apk" -exec ls -la {} \;
          fi

      # 1Ô∏è‚É£2Ô∏è‚É£ Upload Signed APK
      - name: Upload Signed APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: |
            app/build/outputs/apk/release/app-release.apk
            app/build/outputs/apk/release/*.apk
          retention-days: 30

      # 1Ô∏è‚É£3Ô∏è‚É£ Build Signed Release AAB
      - name: Build Signed Release AAB
        run: |
          ./gradlew clean bundleRelease \
            -Pandroid.injected.signing.store.file=$HOME/app/my-release-key.jks \
            -Pandroid.injected.signing.store.password=${{ secrets.KEYSTORE_PASSWORD }} \
            -Pandroid.injected.signing.key.alias=${{ secrets.KEY_ALIAS }} \
            -Pandroid.injected.signing.key.password=${{ secrets.KEY_PASSWORD }}

      # 1Ô∏è‚É£4Ô∏è‚É£ Upload Signed AAB
      - name: Upload Signed AAB
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab
          path: app/build/outputs/bundle/release/app-release.aab
          retention-days: 30

      # 1Ô∏è‚É£5Ô∏è‚É£ Find Actual APK Path for Release
      - name: Discover APK Path
        id: find-apk
        run: |
          # Look for APK files
          APK_PATH=$(find app/build/outputs -name "*.apk" -type f | grep release | head -1)
          if [ -z "$APK_PATH" ]; then
            APK_PATH=$(find app/build/outputs -name "*.apk" -type f | head -1)
          fi
          
          if [ -n "$APK_PATH" ]; then
            echo "üì± Found APK: $APK_PATH"
            echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          else
            echo "‚ùå No APK file found"
            echo "apk_path=" >> $GITHUB_OUTPUT
          fi
          
          # AAB path is usually consistent
          if [ -f "app/build/outputs/bundle/release/app-release.aab" ]; then
            echo "aab_path=app/build/outputs/bundle/release/app-release.aab" >> $GITHUB_OUTPUT
          else
            AAB_PATH=$(find app/build/outputs -name "*.aab" -type f | head -1)
            echo "aab_path=$AAB_PATH" >> $GITHUB_OUTPUT
          fi

      # 1Ô∏è‚É£6Ô∏è‚É£ Create GitHub Release (Only if files exist)
      - name: Create GitHub Release
        if: steps.find-apk.outputs.apk_path != '' && steps.find-apk.outputs.aab_path != ''
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ steps.find-apk.outputs.apk_path }}
            ${{ steps.find-apk.outputs.aab_path }}
          tag_name: release-v${{ github.run_number }}
          name: Release ${{ github.run_number }} (v1.7)
          draft: false
          prerelease: false
          body: |
            üöÄ Automatic Release Build
            
            **Version:** 1.9 (9)
            **Target SDK:** 35 (Play Store Compliant)
            
            ### üì± Download Links:
            - **APK**: Direct installable file
            - **AAB**: For Google Play Store upload
            
            ### üéØ For Testers:
            1. **Download APK** and install directly on Android devices
            2. Enable "Install from unknown sources" if needed
            
            ### üîß Build Info:
            - Min SDK: 21
            - Target SDK: 35
            - Build Date: ${{ github.event.head_commit.timestamp }}

      # 1Ô∏è‚É£7Ô∏è‚É£ Output Tester Instructions
      - name: Output Tester Instructions
        run: |
          echo "üéØ TESTER DOWNLOAD INSTRUCTIONS:"
          echo ""
          echo "OPTION 1 - Direct APK Download from Artifacts:"
          echo "1. Go to GitHub Actions ‚Üí This workflow run"
          echo "2. Download 'app-release-apk' artifact"
          echo "3. Install on Android device"
          echo ""
          echo "OPTION 2 - GitHub Release (if created):"
          echo "1. Go to Repository ‚Üí Releases"
          echo "2. Download latest release APK"
          echo "3. Install on Android device"
          echo ""
          echo "OPTION 3 - Manual Build Download:"
          echo "1. Check workflow artifacts above for APK file"
          echo ""
          echo "üîß Installation Help:"
          echo "- Enable 'Install from unknown sources' in Android settings"
          echo "- Download the APK and tap to install"
