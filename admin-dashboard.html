<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Writer - Admin Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 20px; 
            text-align: center; 
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .login-container { 
            background: white; 
            padding: 40px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            max-width: 500px; 
            margin: 50px auto; 
            text-align: center;
        }
        
        .login-input { 
            width: 100%; 
            padding: 12px; 
            margin: 8px 0; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            font-size: 14px;
        }
        
        .btn { 
            background: #667eea; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px; 
        }
        
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 11px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .test-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .success { color: green; font-weight: bold; }
        .error { color: red; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <div id="app">
        <!-- Login Screen -->
        <div id="loginScreen" class="login-container">
            <h2 style="margin-bottom: 10px;">üîê Admin Dashboard - Authentication Debugger</h2>
            <p style="color: #666; margin-bottom: 20px;">We need to discover how your backend expects authentication</p>
            
            <form id="loginForm" onsubmit="login(event)">
                <input type="text" id="username" class="login-input" placeholder="Admin Username" required value="alakbd2009@gmail.com">
                <input type="password" id="password" class="login-input" placeholder="Admin Password" required>
                
                <button type="submit" class="btn" style="width: 100%; margin-top: 10px; background: #27ae60;">
                    Sign In & Discover Auth Method
                </button>
            </form>
            
            <div id="loginDebug" class="debug-info" style="display: none; margin-top: 20px;"></div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" style="display: none;">
            <div class="header">
                <h1>üîç Authentication Discovery Tool</h1>
                <p>Testing different authentication methods to find what your backend expects</p>
            </div>

            <div class="container">
                <div class="test-section">
                    <h3>üìã Test Results</h3>
                    <div id="authTestResults" class="debug-info"></div>
                </div>

                <div class="test-section">
                    <h3>üîß Manual Test</h3>
                    <p>Try a custom header/value combination:</p>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="customHeader" placeholder="Header name (e.g., X-User-ID)" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <input type="text" id="customValue" placeholder="Header value" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" value="admin-user">
                    </div>
                    <button class="btn" onclick="testCustomAuth()">Test Custom Header</button>
                    <div id="customTestResult" class="debug-info" style="margin-top: 10px; display: none;"></div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="logout()" style="background: #e74c3c;">üö™ Logout</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://resume-writer-api.onrender.com';
        let currentSession = null;

        async function login(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!username || !password) {
                return;
            }

            const loginBtn = document.querySelector('#loginForm button');
            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';
            
            const debugElement = document.getElementById('loginDebug');
            debugElement.style.display = 'block';
            debugElement.innerHTML = '<div>Starting login process...</div>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });
                
                debugElement.innerHTML += `<div>Login response status: ${response.status}</div>`;
                
                const data = await response.json();
                debugElement.innerHTML += `<div>Login response: ${JSON.stringify(data, null, 2)}</div>`;
                
                if (response.ok && data.success) {
                    debugElement.innerHTML += `<div class="success">‚úì Login successful! User ID: ${data.user_id}</div>`;
                    
                    currentSession = {
                        user_id: data.user_id,
                        username: data.username || username,
                        full_response: data // Store everything
                    };
                    
                    localStorage.setItem('adminSession', JSON.stringify(currentSession));
                    
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    
                    await runComprehensiveAuthTests();
                    
                } else {
                    throw new Error(data.detail || data.message || 'Login failed');
                }
            } catch (error) {
                debugElement.innerHTML += `<div class="error">Login error: ${error.message}</div>`;
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In & Discover Auth Method';
            }
        }

        async function runComprehensiveAuthTests() {
            const testResults = document.getElementById('authTestResults');
            testResults.innerHTML = '<div>Running comprehensive authentication tests...</div>';
            
            const testCases = [
                // Basic headers with user_id
                { name: 'X-User-ID', headers: { 'X-User-ID': currentSession.user_id } },
                { name: 'X-User-Id', headers: { 'X-User-Id': currentSession.user_id } },
                { name: 'User-ID', headers: { 'User-ID': currentSession.user_id } },
                { name: 'User-Id', headers: { 'User-Id': currentSession.user_id } },
                
                // Admin specific headers
                { name: 'X-Admin-ID', headers: { 'X-Admin-ID': currentSession.user_id } },
                { name: 'X-Admin-User-ID', headers: { 'X-Admin-User-ID': currentSession.user_id } },
                { name: 'Admin-User-ID', headers: { 'Admin-User-ID': currentSession.user_id } },
                
                // Authorization headers
                { name: 'Authorization: User', headers: { 'Authorization': `User ${currentSession.user_id}` } },
                { name: 'Authorization: Admin', headers: { 'Authorization': `Admin ${currentSession.user_id}` } },
                { name: 'Authorization: Basic (base64 user:pass)', headers: { 'Authorization': `Basic ${btoa('admin:password')}` } },
                
                // API Key styles
                { name: 'X-API-Key', headers: { 'X-API-Key': currentSession.user_id } },
                { name: 'X-API-Token', headers: { 'X-API-Token': currentSession.user_id } },
                { name: 'API-Key', headers: { 'API-Key': currentSession.user_id } },
                
                // Session/token based (if we had a token)
                { name: 'X-Session-ID', headers: { 'X-Session-ID': currentSession.user_id } },
                { name: 'X-Auth-Token', headers: { 'X-Auth-Token': currentSession.user_id } },
                
                // Custom headers that might be used
                { name: 'X-Client-ID', headers: { 'X-Client-ID': currentSession.user_id } },
                { name: 'X-Client-Id', headers: { 'X-Client-Id': currentSession.user_id } },
                
                // No authentication
                { name: 'No headers', headers: {} }
            ];

            let successCount = 0;
            
            for (const testCase of testCases) {
                testResults.innerHTML += `<div>Testing <strong>${testCase.name}</strong>...</div>`;
                
                try {
                    const response = await fetch(`${API_BASE_URL}/admin/stats`, {
                        headers: {
                            'Content-Type': 'application/json',
                            ...testCase.headers
                        }
                    });
                    
                    const responseText = await response.text();
                    
                    if (response.ok) {
                        testResults.innerHTML += `<div class="success">‚úÖ SUCCESS! Status: ${response.status}</div>`;
                        testResults.innerHTML += `<div>Response: ${responseText.substring(0, 200)}...</div>`;
                        successCount++;
                    } else {
                        testResults.innerHTML += `<div class="warning">Status: ${response.status} - ${getStatusText(response.status)}</div>`;
                        if (responseText) {
                            testResults.innerHTML += `<div>Error response: ${responseText.substring(0, 100)}</div>`;
                        }
                    }
                } catch (error) {
                    testResults.innerHTML += `<div class="error">Request failed: ${error.message}</div>`;
                }
                
                testResults.innerHTML += `<div style="border-bottom: 1px solid #eee; margin: 5px 0;"></div>`;
            }

            if (successCount > 0) {
                testResults.innerHTML += `<div class="success" style="margin-top: 10px;">üéâ Found ${successCount} working authentication method(s)!</div>`;
            } else {
                testResults.innerHTML += `<div class="error" style="margin-top: 10px;">‚ùå No standard authentication methods worked.</div>`;
                testResults.innerHTML += `<div style="margin-top: 10px;">This means your backend expects a specific authentication format that we haven't discovered yet.</div>`;
                testResults.innerHTML += `<div>Try using the manual test above with different header combinations, or check your backend code for the expected authentication format.</div>`;
            }
        }

        async function testCustomAuth() {
            const headerName = document.getElementById('customHeader').value.trim();
            const headerValue = document.getElementById('customValue').value.trim();
            const resultDiv = document.getElementById('customTestResult');
            
            if (!headerName || !headerValue) {
                alert('Please enter both header name and value');
                return;
            }

            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `<div>Testing custom header: <strong>${headerName}: ${headerValue}</strong></div>`;
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/stats`, {
                    headers: {
                        'Content-Type': 'application/json',
                        [headerName]: headerValue
                    }
                });
                
                const responseText = await response.text();
                
                if (response.ok) {
                    resultDiv.innerHTML += `<div class="success">‚úÖ SUCCESS! Status: ${response.status}</div>`;
                    resultDiv.innerHTML += `<div>Full response: ${JSON.stringify(JSON.parse(responseText), null, 2)}</div>`;
                } else {
                    resultDiv.innerHTML += `<div class="warning">Status: ${response.status} - ${getStatusText(response.status)}</div>`;
                    if (responseText) {
                        resultDiv.innerHTML += `<div>Error: ${responseText}</div>`;
                    }
                }
            } catch (error) {
                resultDiv.innerHTML += `<div class="error">Request failed: ${error.message}</div>`;
            }
        }

        function getStatusText(status) {
            const statusMap = {
                200: 'OK',
                401: 'Unauthorized',
                403: 'Forbidden', 
                422: 'Unprocessable Entity',
                500: 'Internal Server Error'
            };
            return statusMap[status] || 'Unknown';
        }

        function logout() {
            currentSession = null;
            localStorage.removeItem('adminSession');
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
        }

        // Check for existing session on load
        document.addEventListener('DOMContentLoaded', function() {
            const savedSession = localStorage.getItem('adminSession');
            if (savedSession) {
                currentSession = JSON.parse(savedSession);
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                runComprehensiveAuthTests();
            }
        });
    </script>
</body>
</html>
